networks:
  mapthew:
    name: mapthew-network

volumes:
  dashboard-dist:
  mapthew-workspaces:  # Named volume for workspace persistence
  claude-sessions:     # Named volume for Claude CLI session persistence

services:
  redis:
    container_name: redis
    image: redis:7-alpine
    networks:
      - mapthew
    ports:
      - "${REDIS_PORT:-6379}:6379"

  dashboard:
    container_name: dashboard
    build:
      context: .
      dockerfile: packages/dashboard/Dockerfile
      target: dev
    volumes:
      - ./packages/dashboard/src:/app/packages/dashboard/src
      - ./packages/dashboard/index.html:/app/packages/dashboard/index.html
      - dashboard-dist:/app/packages/dashboard/dist
      - ./.env:/app/.env:ro

  webhook:
    container_name: webhook
    build:
      context: .
      dockerfile: packages/webhook/Dockerfile
      target: dev
    networks:
      - mapthew
    ports:
      - "${WEBHOOK_PORT:-3000}:${WEBHOOK_PORT:-3000}"
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/webhook/src:/app/packages/webhook/src
      - dashboard-dist:/app/packages/dashboard/dist:ro
      - mapthew-workspaces:/tmp/mapthew-workspaces:ro
      - claude-sessions:/data/claude-sessions:ro
    environment:
      - CLAUDE_CONFIG_DIR=/data/claude-sessions
      - PORT=${WEBHOOK_PORT:-3000}
      - REDIS_URL=redis://redis:6379
      - JIRA_BASE_URL
      - JIRA_EMAIL
      - JIRA_API_TOKEN
      - JIRA_WEBHOOK_SECRET
      - GITHUB_WEBHOOK_SECRET
      - FIGMA_API_KEY
    env_file: .env
    depends_on:
      - redis
      - dashboard

  worker:
    container_name: worker-1
    build:
      context: .
      dockerfile: packages/worker/Dockerfile
      target: dev
    networks:
      - mapthew
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/worker/src:/app/packages/worker/src
      - ./packages/worker/instructions:/app/packages/worker/instructions
      - mapthew-workspaces:/tmp/mapthew-workspaces  # Persist session workspaces
      - claude-sessions:/home/worker/.claude         # Persist Claude CLI sessions
    environment:
      - REDIS_URL=redis://redis:6379
      - JIRA_BASE_URL
      - JIRA_EMAIL
      - JIRA_API_TOKEN
      - JIRA_LABEL_ADD
      - JIRA_LABEL_TRIGGER
      - GITHUB_TOKEN
      - FIGMA_API_KEY
      - ANTHROPIC_API_KEY
      - CLAUDE_MODEL
    env_file: .env
    depends_on:
      - redis

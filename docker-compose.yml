networks:
  mapthew:
    name: mapthew-network

volumes:
  dashboard-dist:
  mapthew-workspaces:  # Named volume for workspace persistence
  claude-sessions:     # Named volume for Claude CLI session persistence
  vault-import:        # Shared between vault-init and lowkey-vault

services:
  redis:
    container_name: redis
    image: redis:7-alpine
    networks:
      - mapthew
    ports:
      - "${REDIS_PORT:-6379}:6379"

  vault-init:
    container_name: vault-init
    image: node:22-alpine
    volumes:
      - ./.env.local:/app/.env.local:ro
      - ./scripts/lowkey-vault-init.mjs:/app/generate.mjs:ro
      - vault-import:/output
    environment:
      VAULT_ENV_FILE: /app/.env.local
      VAULT_OUTPUT_DIR: /output
    command: node /app/generate.mjs

  lowkey-vault:
    container_name: lowkey-vault
    image: nagyesta/lowkey-vault:7.1.9
    networks:
      - mapthew
    ports:
      - "8443:8443"
      - "8080:8080"
    volumes:
      - vault-import:/import:ro
    environment:
      LOWKEY_ARGS: >
        --LOWKEY_VAULT_NAMES=-
        --LOWKEY_IMPORT_LOCATION=/import/vault.json.hbs
        --LOWKEY_IMPORT_TEMPLATE_HOST=lowkey-vault
        --LOWKEY_IMPORT_TEMPLATE_PORT=8443
    depends_on:
      vault-init:
        condition: service_completed_successfully

  dashboard:
    container_name: dashboard
    build:
      context: .
      dockerfile: packages/dashboard/Dockerfile
      target: dev
    volumes:
      - ./packages/dashboard/src:/app/packages/dashboard/src
      - ./packages/dashboard/index.html:/app/packages/dashboard/index.html
      - dashboard-dist:/app/packages/dashboard/dist
      - ./.env:/app/.env:ro

  webhook:
    container_name: webhook
    build:
      context: .
      dockerfile: packages/webhook/Dockerfile
      target: dev
    networks:
      - mapthew
    ports:
      - "${WEBHOOK_PORT:-3000}:${WEBHOOK_PORT:-3000}"
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/webhook/src:/app/packages/webhook/src
      - dashboard-dist:/app/packages/dashboard/dist:ro
      - mapthew-workspaces:/tmp/mapthew-workspaces
      - claude-sessions:/data/claude-sessions
    environment:
      - CLAUDE_CONFIG_DIR=/data/claude-sessions
      - PORT=${WEBHOOK_PORT:-3000}
      - REDIS_URL=redis://redis:6379
      # LOCAL DEV ONLY — required for Lowkey Vault self-signed certs. DO NOT use in production.
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - AZURE_KEYVAULT_URL
      - AZURE_IDENTITY_ENDPOINT
      - AZURE_IDENTITY_HEADER
    env_file: .env
    depends_on:
      - redis
      - dashboard
      - lowkey-vault

  worker:
    container_name: worker-1
    build:
      context: .
      dockerfile: packages/worker/Dockerfile
      target: dev
    networks:
      - mapthew
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/worker/src:/app/packages/worker/src
      - ./packages/worker/instructions:/app/packages/worker/instructions
      - mapthew-workspaces:/tmp/mapthew-workspaces  # Persist session workspaces
      - claude-sessions:/home/worker/.claude         # Persist Claude CLI sessions
    environment:
      - REDIS_URL=redis://redis:6379
      # LOCAL DEV ONLY — required for Lowkey Vault self-signed certs. DO NOT use in production.
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - AZURE_KEYVAULT_URL
      - AZURE_IDENTITY_ENDPOINT
      - AZURE_IDENTITY_HEADER
    env_file: .env
    depends_on:
      - redis
      - lowkey-vault
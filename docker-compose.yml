networks:
  mapthew:
    name: mapthew-network

services:
  redis:
    container_name: redis
    image: redis:7-alpine
    networks:
      - mapthew
    ports:
      - "${REDIS_PORT:-6379}:6379"

  webhook:
    container_name: webhook
    build:
      context: .
      dockerfile: packages/webhook/Dockerfile
      target: dev
    networks:
      - mapthew
    ports:
      - "${WEBHOOK_PORT:-3000}:${WEBHOOK_PORT:-3000}"
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/webhook/src:/app/packages/webhook/src
    environment:
      - PORT=${WEBHOOK_PORT:-3000}
      - REDIS_URL=redis://redis:6379
      - JIRA_BASE_URL
      - JIRA_EMAIL
      - JIRA_API_TOKEN
      - JIRA_WEBHOOK_SECRET
      - GITHUB_WEBHOOK_SECRET
    env_file: .env
    depends_on:
      - redis

  worker:
    container_name: worker-1
    build:
      context: .
      dockerfile: packages/worker/Dockerfile
      target: dev
    networks:
      - mapthew
    volumes:
      - ./packages/shared/src:/app/packages/shared/src
      - ./packages/worker/src:/app/packages/worker/src
      - ./packages/worker/instructions:/app/packages/worker/instructions
    environment:
      - REDIS_URL=redis://redis:6379
      - JIRA_BASE_URL
      - JIRA_EMAIL
      - JIRA_API_TOKEN
      - JIRA_LABEL_ADD
      - JIRA_LABEL_REMOVE
      - JIRA_DONE_STATUS
      - GITHUB_TOKEN
      - ANTHROPIC_API_KEY
      - CLAUDE_MODEL
    env_file: .env
    depends_on:
      - redis
